---
title: 
tags:
  - java
  - programming
  - spring
  - aop
  - proxy
publish: true
date: 2025-01-04 07:10
comments: true
---
## 배경

#### 핵심 기능과 부가 기능
- 어플리케이션 로직은 크게 **핵심 기능**과 **부가 기능**으로 나눌 수 있다.
- 핵심 기능은 특정 객체가 제공하는 고유의 기능이다. 예를 들어 `OrderService`의 핵심 기능은 주문 로직이다.
- 부가 기능은 핵심 기능을 보조하기 위해 제공되는 기능이다. 예를 들어 로그 추적, 트랜잭션 기능등이 있다.
- 이런 부가 기능은 단독으로는 사용되지 않는다. 예를 들어 로그 추적 기능은 어떤 핵심 기능이 호출되었는지 로그를 남기기 위해서 사용한다.

#### 횡단 관심사(cross-cutting concerns)
![[aop-1.png]]
- 보통 부가 기능은 여러 클래스에 걸쳐서 함께 사용된다. 예를 들면 모든 어플리케이션 호출을 로깅해야 하는 요구사항 같은 경우다.
- 이러한 부가 기능은 횡단 관심사가 된다. 쉽게 이야기해서 하나의 부가 기능이 여러 곳에서 동일하게 사용된다는 뜻이다.

#### 부가 기능 적용 문제
- 그런데 이런 부가 기능을 어플리케이션 전반에 공통적으로 적용하는 것은 쉬운 일이 아니다.
	- 적용해야 할 클래스가 100개라면 100개 모두 적용해야 한다.
	- 핵심 기능과 부가 기능이 섞여 가독성을 해치고, 유지보수를 어렵게 한다.
	- 부가 기능이 여러 곳에 퍼져서 중복 코드를 만들어낸다.
	- 부가 기능을 변경할 때 중복 때문에 많은 수정이 필요하다.
	- 부가 기능의 적용 대상을 변경할 때 많은 수정이 필요하다.
- 부가 기능처럼 특정 로직을 어플리케이션 전반에 적용하는 문제는 일반적인 OOP 방식으로는 해결이 어렵다.

#### 핵심 기능과 부가 기능 분리
- 누군가는 이런 부가 기능 도입의 문제 해결을 위해 오랜 기간 고민했다.
- **애스펙트 Aspect**는 이런 부가 기능 도입의 문제를 해결하기 위해 만들어진 모듈이다.
- 부가 기능과 핵심 기능을 분리하고, 부가 기능을 어디에 적용할 지 정의한 것이다.
- 스프링이 제공하는 **어드바이저**도 **어드바이스**와 **포인트컷**을 가지고 있어서 개념상 하나의 애스펙트이다.

#### 애스펙트 Aspect
![[aop-2.png]]

- 애스펙트는 해석하면 관점이라는 뜻인데, 이름 그대로 어플리케이션을 바라보는 관점을 하나 하나의 기능에서 횡단 관심사 관점으로 달리 보는 것이다.
- 이렇게 애스펙트를 사용한 프로그래밍 방식을 **관점 지향 프로그래밍 AOP(Aspect-Oriented Programming)**라 한다.
- 이 AOP는 OOP를 대체하기 위한 것이 아니라, 횡단 관심사를 깔끔하게 처리하기 어려운 OOP를 보조하는 목적으로 개발되었다.


## AspectJ 프레임워크
- AOP의 대표적인 구현으로는 [AspectJ 프레임워크](https://www.eclipse.org/aspectj/)가 있다.
- 스프링도 AOP를 지원하지만 대부분 `AspectJ`의 문법을 차용하고, `AspectJ`가 제공하는 기능의 일부만 제공한다.

## AOP 적용 방식
- AOP를 사용하면 핵심 기능과 부가 기능이 코드상 완전히 분리되어 관리된다.
- 크게 3가지 방법으로 구분 된다.
#### 컴파일 시점

![[aop-3.png]]
- `.java` 소스 코드를 컴파일러를 사용해서 `.class`를 만드는 시점에 부가 기능 로직을 추가한다.
- 이 때는 `AspectJ`가 제공하는 특별한 컴파일러를 사용해야 한다.
- `AspectJ` 컴파일러는 `Aspect`를 확인해서 해당 클래스가 적용 대상인지 먼저 확인하고, 적용 대상인 경우에 부가 기능 로직을 적용한다.
- 이렇게 원본 로직에 부가 기능 로직이 추가되는 것을 **위빙(Weaving)**이라 한다.
> Weaving: 옷감을 짜다, 직조하다. -> 애스펙트와 실제 코드를 연결하는 것 

- **단점**
	- 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡하다.

#### 클래스 로딩 시점
![[aop-4.png]]
- 자바를 실행하면 `.class` 파일을 JVM 내부의 클래스 로더에 보관한다. 이 때 중간에서 `.class` 파일을 조작한 다음 JVM에 올릴 수 있다.
- 자바 언어는 `.class`를 JVM에 저장하기 전에 조작할 수 있는 기능을 제공한다. 이와 관련해서는 `java Instrumentation`을 검색하면 다양한 자료가 나온다.
- 참고로 수 많은 모니터링 툴들이 이 방식을 사용한다.
- 이 시점에 애스펙트를 적용하는 것을 **로드 타임 위빙**이라 한다.

- **단점**
	- 로드 타임 위빙은 자바를 실행할 때 특별한 옵션(`java -javaagent`)을 통해 클래스 로더 조작기를 지정하고 해야하는데 이 부분이 번거롭고 운영하기 어렵다.

#### 런타임 시점
![[aop-5.png]]
- 런타임 시점은 컴파일이 다 끝나고 클래스 로더에 클래스도 다 올라가서 이미 자바가 실행되고 난 다음을 말한다.
- 자바의 메인(`main`) 메서드가 실행된 다음이다. 따라서 자바 언어가 제공하는 범위 안에서 부가 기능을 적용해야 한다.
- 스프링과 같은 컨테이너의 도움을 받고 [[프록시 패턴과 데코레이터 패턴|프록시]]와 [[스프링 입문 1#스프링 빈 등록과 의존관계 설정|의존 관계 주입]], [[빈 후처리기]] 같은 개념들을 총 동원해야 한다.
- 이렇게 하면 최종적으로 프록시를 통해 스프링 빈에 부가 기능을 적용할 수 있다. 지금까지 학습한 것이 바로 **프록시 방식의 AOP**이다.
- 프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다. 하지만 특별한 컴파일러나 자바를 실행할 때 복잡한 옵션과 클래스 로더 조작기를 설정하지 않아도 된다. 스프링만 있으면 AOP를 적용할 수 있다.

#### 시점 별 차이 정리
- 소스코드 조작을 통한 위빙
	- **컴파일 시점**: 실제 대상 코드에 애스펙트를 통한 부가 기능 호출 코드가 포함된다. `AspectJ`를 직접 사용해야 한다.
	- **클래스 로딩 시점**: 실제 대상 코드에 애스펙트를 통한 부가 기능 호출 코드가 포함된다. `AspectJ`를 직접 사용해야 한다.
- 프록시를 통한 위빙
	- **런타임 시점**: 실제 대상 코드는 그대로 유지된다. 대신 프록시를 통해 부가 기능이 적용된다. 따라서 항상 프록시를 통해야 부가 기능을 사용할 수 있다.

## 스프링 AOP와 AspectJ
- 스프링은 `AspectJ`의 문법만 가져와서 사용하고, 프록시 방식의 AOP를 적용한다.
- 실무에서는 스프링이 제공하는 AOP만 사용해도 대부분의 문제를 해결할 수 있다.

## 조인 포인트(JoinPoint)
![[aop-6.png]]
- 어드바이스가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점을 의미한다.
- AOP를 적용할 수 있는 모든 지점이라 생각하면 된다. 조인 포인트는 추상적인 개념이다.
- 스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메서드 실행 지점이다.

## 포인트 컷(Pointcut)
![[aop-7.png]]
- 조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
- 주로 `AspectJ` 표현식을 사용해서 지정
- 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트 컷으로 선별 가능
## 타겟(Target)
- 어드바이스를 받는 객체, 포인트컷으로 지정

## 어드바이스(Advice)
- 부가 기능
- 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
- Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있다.

## 애스펙트(Aspect)
- 어드바이스 + 포인트 컷을 모듈화 한 것
- `@Aspect`를 생각하면 된다.
- 여러 어드바이스와 포인트 컷이 함께 존재

## 어드바이저(Advisor)
- 하나의 어드바이스와 하나의 포인트 컷으로 구성
- 스프링 AOP에서만 사용되는 특별한 용어

## 위빙(Weaving)
- 포인트컷으로 결정한 타겟의 조인 포인트에 어드바이스를 적용하는 것
- 위빙을 통해 핵심 기능에 영향을 주지 않고 부가 기능을 추가할 수 있다.
- AOP 적용을 위해 애스펙트를 객체에 연결한 상태
	- 컴파일 타임(AspectJ Compiler)
	- 로드 타임
	- 런타임

## AOP 프록시
- AOP 기능을 구현하기 위해 만든 프록시 객체, 스프링에서 AOP 프록시는 `JDK 동적 프록시` 또는 `CGLIB 프록시`이다.

---

References: 김영한의 스프링 핵심 원리 - 고급편

Links to this page: [[프록시 패턴과 데코레이터 패턴]], [[스프링 입문 1]], [[빈 후처리기]], [[스프링 AOP 구현]], [[스프링 AOP 실전 예제]]
