#elysiaJS 

# 개요

| 메서드           | 시점          | 용도               | 접근                  |
| ------------- | ----------- | ---------------- | ------------------- |
| `.decorate()` | 앱 시작 (1회)   | 서비스, DB          | `context.xxx`       |
| `.state()`    | 앱 시작        | 가변 상태            | `context.store.xxx` |
| `.derive()`   | 요청마다 (검증 전) | 토큰 추출, requestId | `context.xxx`       |
| `.resolve()`  | 요청마다 (검증 후) | DB 조회 (비동기)      | `context.xxx`       |
| `.macro()`    | 라우트 정의      | 라우트별 옵션          | `{ option: value }` |
| `.guard()`    | 라우트 그룹      | 공통 미들웨어          | N/A                 |

## `.decorate()` - 싱글턴

```typescript
.decorate("db", new Database())
.get("/", ({ db }) => db.query("..."))
```

## `.state()` - 전역 상태

```typescript
.state("count", 0)
.get("/", ({ store }) => ++store.count)
```

⚠️ 메모리 기반, 서버 재시작 시 초기화.

# `.derive()` - 요청별 동기

```typescript
.derive(({ headers }) => ({
  token: headers.authorization,
}))
.get("/", ({ token }) => token)
```

# `.resolve()` - 요청별 비동기

```typescript
.resolve(async ({ params }) => ({
  user: await db.findUser(params.id),
}))
.get("/user/:id", ({ user }) => user)
```


# `.macro()` - 라우트 옵션

```typescript
.macro({
  role: (r: "admin" | "user") => ({
    beforeHandle: ({ user }) => {
      if (user?.role !== r) throw new AuthError("권한 없음");
    },
  }),
})
.get("/admin", () => "관리자", { role: "admin" })
```

# `.guard()` - 공통 미들웨어

```typescript
.guard({
  beforeHandle: ({ headers }) => {
    if (!headers.authorization) throw new AuthError("인증 필요");
  },
})
.get("/a", () => "a")  // 가드 적용
.get("/b", () => "b")  // 가드 적용
```


# `.as()` - 스코프

| 값        | 범위        |
| -------- | --------- |
| `local`  | 플러그인 내부   |
| `scoped` | 플러그인 + 부모 |
| `global` | 앱 전체      |

# 실행 순서

```
요청 → derive → 검증 → resolve → beforeHandle → 핸들러 → afterHandle → 응답
```

# 선택 가이드
| 상황 | 사용 |
|------|------|
| 토큰 추출, requestId | `.derive()` |
| 유저 DB 조회 | `.resolve()` |
| 라우트별 인증/역할 | `.macro()` |
| 그룹 공통 로직 | `.guard()` |
| 요청/응답 로깅 | `onRequest`, `onResponse` |
| 인증 체크 | `onBeforeHandle` |
| 응답 래핑 | `onAfterHandle` |
| 에러 포맷팅 | `onError` |
